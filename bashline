#!/bin/bash

bashline_hsep() {
    fg=$1
    bg=$2
    rest=$3
    if [ -n "$rest" ] ; then
        rest=${rest//,/;}
        rest=";$rest"
    fi
    echo -n ' '
    cutstart='\['
    cutstop='\]'
    arrowset=$cutstart'\e['$(( bg - 10 ))';7;21m'$cutstop
    arrow=''
    arrowend=$cutstart'\e['$fg';'$bg$rest';27m'$cutstop
    echo -ne $arrowset$arrow$arrowend
}

bashline_col() {
    args=$fg\;$bg
    if [ -n "$3" ] ; then
        rest=$3
        args+=\;${rest//,/;}
    fi
    cutstart='\['
    color='\e['$args'm'
    cutstop='\]'
    echo -ne $cutstart$color$cutstop
}

check () {
    read temp_var
    args=$@
    args=${args//pinput/$temp_var}
    test $args && echo "$temp_var"
}

bashline_load_blocks() {
    bashline_fgs=()
    bashline_bgs=()
    bashline_modifs=()
    bashline_opts=()
    bashline_blocks=()

    while read line ; do
        [[ $line == \#* ]] && continue
        cols=`echo $line | cut -d';' -f1 | xargs`
        opts=`echo $line | cut -d';' -f2 | xargs`
        block=`echo "$line" | cut -d';' -f3- `

        fg=`echo "$cols" | cut -d',' -f1`
        bg=`echo "$cols" | cut -d',' -f2`
        modif=`echo "$cols" | cut -d',' -f3-`

        bashline_fgs+=("$fg")
        bashline_bgs+=("$bg")
        bashline_modifs+=("$modif")
        bashline_opts+=("$opts")
        bashline_blocks+=("$block")
    done < $1
}

bashline_prompt() {
    PS1=''

    for index in `seq 0 ${#bashline_bgs[*]}`; do
        local fg=${bashline_fgs[index]}
        local bg=${bashline_bgs[index]}
        local modif=${bashline_modifs[index]}
        local opts=${bashline_opts[index]}
        local block=${bashline_blocks[index]}

        if [[ "$block" != \\* ]] ; then
            local result=`eval "$block"`
        else
            local result=$block
        fi

        [ -z "$result" ] && continue
        IFS=',' read -r -a options <<< "$opts"
        for ind in `seq 0 ${#options[*]}` ; do
            case "${options[ind]}" in
                split*)
                    delimiter=`echo "${options[ind]}" | cut -d':' -f2`
                    colorfg=`echo "${options[ind]}" | cut -d':' -f3`
                    if [ -z "$colorfg" ] ; then
                        separator='  '
                    else
                        separator='\[\e['$colorfg'm\]  \[\e['$fg'm\]'
                    fi
                    result=${result//$delimiter/$separator}
                    ;;
            esac
        done


        if [ -n "$PS1" ] ; then
            PS1+="$(bashline_hsep $fg $bg "$modif") $result"
        else
            PS1+="$(bashline_col $fg $bg "$modif") $result"
        fi
    done 

    PS1+="$(bashline_hsep 97 40)\[\e[0m\]"
}

bashline_config=~/.config/bashline/blocks

while [[ "$#" > 0 ]] ; do
    key=$1
    case $key in
        -c)
            shift
            bashline_config=$1
            ;;
    esac
    shift
done

bashline_load_blocks $bashline_config


export PROMPT_COMMAND=bashline_prompt
